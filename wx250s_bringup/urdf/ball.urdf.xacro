<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro" name="ball">
  <!-- Ball properties -->
  <xacro:property name="radius" value="0.015" />
  <xacro:property name="mass" value="0.050" />
  <xacro:property name="inertia_val" value="${(2.0/5.0) * mass * radius * radius}" />
  
  <!-- World link -->
  <link name="world"/>
  
  <!-- The ball link -->
  <link name="ball_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <sphere radius="${radius}" />
      </geometry>
      <material name="red">
        <color rgba="1 0 0 1"/>
      </material>
    </visual>

    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <sphere radius="${radius}" />
      </geometry>
    </collision>

    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="${mass}" />
      <inertia ixx="${inertia_val}" ixy="0.0" ixz="0.0"
               iyy="${inertia_val}" iyz="0.0" izz="${inertia_val}" />
    </inertial>
  </link>

  <!-- Virtual floating joint to track ball position -->
  <joint name="ball_world_joint" type="floating">
    <parent link="world"/>
    <child link="ball_link"/>
  </joint>

  <gazebo reference="ball_link">
    <!-- Basic properties -->
    <material>Gazebo/Red</material>
    <auto_disable>false</auto_disable>
    
    <!-- Enhanced physics properties -->
    <mu1 value="0.5"/>
    <mu2 value="0.5"/>
    <kp value="1000000.0"/>
    <kd value="1.0"/>
    <fdir1>0 0 0</fdir1>
    <maxContacts>5</maxContacts>
    <minDepth>0.001</minDepth>
  </gazebo>

  <!-- Position publisher plugin for ball -->
  <gazebo>
    <plugin name="p3d_base_controller" filename="libgazebo_ros_p3d.so">
      <ros>
        <namespace>/${robot_name}</namespace>
        <remapping>odom:=pose</remapping>
      </ros>
      <body_name>ball_link</body_name>
      <frame_name>world</frame_name>
      <update_rate>100.0</update_rate> # Frequency with which the position is published
      <xyz_offset>0 0 0</xyz_offset>
      <rpy_offset>0 0 0</rpy_offset>
      <gaussian_noise>0.01</gaussian_noise>
    </plugin>
  </gazebo>

  <!-- Joint state publisher plugin (fixed to use the correct joint name) -->
  <gazebo>
    <plugin name="joint_state_publisher" filename="libgazebo_ros_joint_state_publisher.so">
      <ros>
        <namespace>/${robot_name}</namespace>
      </ros>
      <joint_name>ball_world_joint</joint_name>
      <update_rate>30.0</update_rate>
    </plugin>
  </gazebo>
</robot>